<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>환불 요청</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div th:replace="fragments/member_header :: navbar"></div>

<div class="container mt-5">
    <h2 class="mb-4">환불 요청</h2>

    <form th:action="@{/membership/refund/request}" method="post" th:object="${refund}">
        <!-- 회원권 ID -->
        <input type="hidden" id="membershipId" th:field="*{membershipId}" />
        <input type="hidden" id="endDate" th:value="${refund.endDate}" />
        <input type="hidden" id="periodDays" th:value="${refund.periodDays}" />

        <!-- 회원명 -->
        <div class="mb-3">
            <label for="memberName" class="form-label">회원명</label>
            <input type="text" id="memberName" class="form-control" th:field="*{memberName}" readonly />
        </div>

        <!-- 회원권 종류 -->
        <div class="mb-3">
            <label class="form-label">회원권 종류</label>
            <span th:if="${refund.membershipType == 'PT'}" class="form-control">PT</span>
            <span th:if="${refund.membershipType == 'gym'}" class="form-control">헬스장 이용권</span>
            <span th:if="${refund.membershipType == 'pilates'}" class="form-control">필라테스</span>
        </div>

        <!-- 회원권 결제금액 -->
        <div class="mb-3">
            <label for="membershipPrice" class="form-label">회원권 가격</label>
            <input type="text" id="membershipPrice" class="form-control" th:value="${refund.membershipPrice}" readonly />
        </div>

        <!-- 환불 사유 -->
        <div class="mb-3">
            <label for="refundReason" class="form-label">환불 사유</label>
            <textarea id="refundReason" th:field="*{refundReason}" class="form-control" rows="4" required></textarea>
        </div>

        <!-- 환불 예상 금액 (읽기 전용 또는 계산 후 표시) -->
        <div class="mb-3">
            <label for="expectedRefundAmount" class="form-label">예상 환불 금액</label>
            <input type="text" id="expectedRefundAmountDisplay" class="form-control" th:field="*{expectedRefundAmount}" readonly />
            <input type="hidden" id="expectedRefundAmount" class="form-control" th:field="*{expectedRefundAmount}" readonly />
        </div>

        <!-- 버튼 영역 -->
        <div class="d-flex justify-content-between">
            <a th:href="@{/membership/list}" class="btn btn-secondary">뒤로가기</a>
            <button type="submit" class="btn btn-primary">환불 요청</button>
        </div>
    </form>
</div>

<script>
    // 셋째 자리마다 콤마 찍기
    function formatWithComma(number) {
        return Number(number).toLocaleString();
    }

    // 환불 예상 금액 계산 로직
    function calculateExpectedRefundAmount() {
        const price = parseInt(document.getElementById('membershipPrice').value);
        const periodDays = parseInt(document.getElementById('periodDays').value);
        const endDate = new Date(document.getElementById('endDate').value);
        const today = new Date();

        const timeDiff = endDate - today;
        const remainingDays = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));

        if (remainingDays < (periodDays / 2)) {
            alert('남은 기간이 50% 미만으로 환불이 불가능합니다.');
            document.getElementById('expectedRefundAmountDisplay').value = formatWithComma(0);
            document.getElementById('expectedRefundAmount').value = 0;
            return;
        }

        const refundAmount = Math.floor((remainingDays / periodDays) * price);
        document.getElementById('expectedRefundAmount').value = refundAmount;
        document.getElementById('expectedRefundAmountDisplay').value = formatWithComma(refundAmount);
        document.getElementById('membershipPrice').value = formatWithComma(price);
    }

    // 페이지 로드 후 자동 실행
    window.onload = function() {
        calculateExpectedRefundAmount();
    };

</script>

</body>
</html>
