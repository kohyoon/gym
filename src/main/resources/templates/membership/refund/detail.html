<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <title sec:authorize="hasRole('ADMIN')">[관리자] 환불 상세</title>
  <title sec:authorize="hasRole('MEMBER')">[회원] 환불 상세</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Bundle JS (Popper 포함) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<div class="container mt-5">
  <h2 class="mb-4">환불 상세 정보</h2>

  <!-- 회원권 정보 -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">회원권 정보</div>
    <div class="card-body">
      <p><strong>회원권 ID:</strong> <span th:text="${membership.membershipId}"></span></p>
      <p><strong>회원권 종류:</strong> <span th:text="${membership.membershipType}"></span></p>
      <p><strong>가격:</strong> <span th:text="${membership.price} + '원'"></span></p>
      <p><strong>기간:</strong> <span th:text="${membership.periodDays} + '일'"></span></p>
    </div>
  </div>

  <!-- 환불 정보 -->
  <div class="card mb-4">
    <div class="card-header bg-warning">환불 정보</div>
    <div class="card-body">
      <p><strong>환불 ID:</strong> <span th:text="${refund.refundId}"></span></p>
      <p><strong>회원 이름:</strong> <span th:text="${refund.memberName}"></span></p>
      <p><strong>환불 금액:</strong> <span th:if="${refund.refundAmount != null}" th:text="${refund.refundAmount} + '원'"></span></p>
      <p><strong>환불 사유:</strong> <span th:text="${refund.refundReason}"></span></p>
      <p><strong>요청일:</strong> <span th:text="${#temporals.format(refund.requestedAt, 'yyyy-MM-dd HH:mm')}"></span></p>
      <p><strong>요청자:</strong> <span th:text="${refund.requestedByName}"></span></p>
      <p><strong>상태:</strong>
        <span th:switch="${refund.refundStatus.name()}">
          <span th:case="REQUESTED" class="badge bg-warning text-dark">요청됨</span>
          <span th:case="PENDING" class="badge bg-secondary">검토중</span>
          <span th:case="APPROVED" class="badge bg-success">승인</span>
          <span th:case="REJECTED" class="badge bg-danger">반려</span>
        </span>
      </p>
    </div>
  </div>

  <!-- 환불 로그 -->
  <div class="card">
    <div class="card-header bg-secondary text-white">환불 로그</div>
    <div class="card-body">
      <table class="table table-bordered table-hover">
        <thead class="table-light">
        <tr>
          <th>로그 ID</th>
          <th>유형</th>
          <th>내용</th>
          <th>수행 일시</th>
          <th>수행자</th>
          <th>역할</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="log : ${refund.logs}">
          <td th:text="${log.logId}"></td>
          <td>
            <span th:if="${log.logType.name() == 'REQUESTED'}">요청</span>
            <span th:if="${log.logType.name() == 'PENDING'}">검토중</span>
            <span th:if="${log.logType.name() == 'APPROVED'}">승인</span>
            <span th:if="${log.logType.name() == 'REJECTED'}">반려</span>
          </td>
          <td th:text="${log.logDetail}"></td>
          <td th:text="${#temporals.format(log.performedAt, 'yyyy-MM-dd')}"></td>
          <td th:text="${log.performedByName}"></td>
          <td>
            <span th:if="${log.actorRole.name() == 'MEMBER'}">회원</span>
            <span th:if="${log.actorRole.name() == 'ADMIN'}">관리자</span>
          </td>
        </tr>
        <tr th:if="${#lists.isEmpty(refund.logs)}">
          <td colspan="6" class="text-center">로그 내역이 없습니다.</td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- 버튼 -->
  <div class="mt-4" sec:authorize="hasRole('MEMBER')">
    <a th:href="@{/member/refund/list}" class="btn btn-secondary">목록으로</a>
  </div>

  <!-- 버튼 -->
  <div class="d-flex justify-content-end align-items-center gap-3" sec:authorize="hasRole('ADMIN')">
    <form th:if="${refund}"
          th:action="@{/admin/refund/pending/{id}(id=${refund.refundId})}" method="post">
      <button type="submit" class="btn btn-secondary"
              onclick="return confirm('검토중으로 상태 변경 처리하시겠습니까?');">검토중</button>
    </form>

    <form th:if="${refund}"
          th:action="@{/admin/refund/approved/{id}(id=${refund.refundId})}" method="post">
      <button type="submit" class="btn btn-secondary"
              onclick="return confirm('승인 처리하시겠습니까?');">승인</button>
    </form>

    <!-- 반려 버튼: 모달 열기 -->
    <button type="button" class="btn btn-danger"
            data-bs-toggle="modal" data-bs-target="#rejectModal">
      반려
    </button>

    <a th:href="@{/admin/refund/list}" class="btn btn-secondary">목록으로</a>
  </div>

  <!-- 반려 모달 -->
  <div class="modal fade" id="rejectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form th:if="${refund}"
            th:action="@{/admin/refund/rejected/{id}(id=${refund.refundId})}" method="post" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">반려 사유 입력</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"
                  aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label for="rejectReason" class="form-label">반려 사유</label>
            <textarea id="rejectReason" name="rejectReason"
                      class="form-control" rows="4"
                      required minlength="2" maxlength="200"
                      placeholder="반려 사유를 입력하세요(최대 200자)"></textarea>
            <div class="form-text">최대 200자. 민감정보 입력 금지.</div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary"
                  data-bs-dismiss="modal">취소</button>
          <button type="submit" class="btn btn-danger"
                  onclick="return confirm('반려 처리하시겠습니까?');">반려 처리</button>
        </div>
      </form>
    </div>
  </div>

</div>
</body>
</html>
